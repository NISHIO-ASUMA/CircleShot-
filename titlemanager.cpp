//==========================================
//
// タイトル管理処理 [ titlemanager.cpp ]
// Author: Asuma Nishio
// 
//==========================================

//***************************
// インクルードファイル宣言
//***************************
#include "titlemanager.h"
#include "titleui.h"
#include "manager.h"
#include "game.h"
#include "tutorial.h"
#include "input.h"
#include "block.h"
#include "meshfield.h"
#include "meshdome.h"
#include "titleplayer.h"
#include "ui.h"
#include "sound.h"
#include "titlelogo.h"
#include "edit.h"
#include "pausemanager.h"
#include "pointui.h"

//============================
// コンストラクタ
//============================
CTitleManager::CTitleManager(bool isCreate) : m_isFirstuiCreate(isCreate)
{
	// 値のクリア
	m_nIdx = NULL;

	for (int nCnt = 0; nCnt < TITLE_MENU; nCnt++)
	{
		m_pTitleui[nCnt] = nullptr;
	}
	m_pPointUi = nullptr;
	m_isuiCreate = false;
}
//============================
// デストラクタ
//============================
CTitleManager::~CTitleManager()
{
	// 無し
}
//============================
// 初期化処理
//============================
HRESULT CTitleManager::Init(void)
{	
	// 他のシーン等から戻ってきたとき
	if (!m_isFirstuiCreate) 
	{
		// 基準座標を設定
		D3DXVECTOR3 CenterPos = D3DXVECTOR3(210.0f, 540.0f, 0.0f);

		// タイトルのuiを生成
		for (int nCnt = 0; nCnt < TITLE_MENU; nCnt++)
		{
			// 横の間隔を空ける
			D3DXVECTOR3 pos = CenterPos;

			pos.x += nCnt * INTERVAL;

			// uiを生成
			m_pTitleui[nCnt] = CTitleUi::Create(pos, COLOR_WHITE, UIWIDTH, UIHEIGHT, nCnt);
		}

		// フラグを有効化
		m_isuiCreate = true;
	}

	// 地面生成
	CMeshField::Create(VECTOR3_NULL, FIELDWIDTH);

	// 球状メッシュを生成
	CMeshDome::Create(D3DXVECTOR3(0.0f, -70.0f, 0.0f), 500.0f);

	// タイトルプレイヤーを生成
	CTitlePlayer::Create(D3DXVECTOR3(180.0f,0.0f,0.0f),VECTOR3_NULL, 0, "data\\MOTION\\Player\\TitlePlayer100.txt");
	CTitlePlayer::Create(D3DXVECTOR3(260.0f,0.0f,0.0f),VECTOR3_NULL, 1, "data\\MOTION\\Player\\TitlePlayer200.txt");

	// タイトルロゴ生成
	CTitleLogo::Create(D3DXVECTOR3(200.0f, 90.0f, 0.0f), 200.0f, 60.0f, 1);

	// UI生成
	CUi::Create(D3DXVECTOR3(SCREEN_WIDTH * 0.5f, 650.0f, 0.0f),30, 200.0f, 60.0f, "data\\TEXTURE\\Enterkey.png", true);

	// サウンド取得
	CSound* pSound = CManager::GetSound();

	// nullだったら
	if (pSound == nullptr) return E_FAIL;

	// サウンド再生
	// pSound->PlaySound(CSound::SOUND_LABEL_TITLE_BGM);

	// 初期化結果を返す
	return S_OK;
}
//============================
// 終了処理
//============================
void CTitleManager::Uninit(void)
{
	// 無し
}
//============================
// 更新処理
//============================
void CTitleManager::Update(void)
{
	// 入力デバイス取得
	CInputKeyboard* pKey = CManager::GetInputKeyboard();
	CJoyPad* pJoyPad = CManager::GetJoyPad();

	// 取得失敗時
	if (pKey == nullptr) return;
	if (pJoyPad == nullptr) return;

	// サウンド取得
	CSound* pSound = CManager::GetSound();

	// nullだったら
	if (pSound == nullptr) return;

	// カメラ取得
	CCamera* pCamera = CManager::GetCamera();

	// 取得失敗時
	if (pCamera == nullptr) return;

	// キー入力時 かつ uiが生成されていなかったら
	if ((pKey->GetTrigger(DIK_RETURN) || pJoyPad->GetTrigger(pJoyPad->JOYKEY_START)) && !m_isuiCreate)
	{
		// 基準座標を設定
		D3DXVECTOR3 CenterPos = D3DXVECTOR3(210.0f, 540.0f, 0.0f);

		// タイトルのuiを生成
		for (int nCnt = 0; nCnt < TITLE_MENU; nCnt++)
		{
			// 横の間隔を空ける
			D3DXVECTOR3 pos = CenterPos;

			pos.x += nCnt * INTERVAL;

			// uiを生成
			m_pTitleui[nCnt] = CTitleUi::Create(pos, COLOR_WHITE, UIWIDTH, UIHEIGHT, nCnt);
		}

		// nullなら
		if (!m_pPointUi)
		{
			// 最初は選択中のUI位置
			D3DXVECTOR3 pos = m_pTitleui[m_nIdx]->GetPos(); 

			// 選択メニューの上に生成
			pos.y -= 100.0f; 

			// 矢印UI生成
			m_pPointUi = CPointUi::Create(pos);
		}

		// フラグを有効化
		m_isuiCreate = true;
	}

	// 上キー入力
	if (pKey->GetTrigger(DIK_LEFT) || pJoyPad->GetTrigger(pJoyPad->JOYKEY_LEFT) || pKey->GetTrigger(DIK_A))
	{
		// サウンド再生
		pSound->PlaySound(CSound::SOUND_LABEL_SELECT);

		// インデックス番号を減算
		m_nIdx--;

		// 最小値以下なら最小値に設定
		if (m_nIdx < SELECT_START)
			m_nIdx = SELECT_END;
	}

	// 下キー入力
	if (pKey->GetTrigger(DIK_RIGHT) || pJoyPad->GetTrigger(pJoyPad->JOYKEY_RIGHT) || pKey->GetTrigger(DIK_D))
	{
		// サウンド再生
		pSound->PlaySound(CSound::SOUND_LABEL_SELECT);

		// インデックス番号を加算
		m_nIdx++;

		// 最大値以上なら最大値に設定
		if (m_nIdx > SELECT_END)
			m_nIdx = SELECT_START;
	}

	// フェード取得
	CFade* pFade = CManager::GetFade();

	// nullだったら
	if (pFade == nullptr) return;

	// 選択されているメニューのポリゴンカラーを変更
	for (int nCnt = 0; nCnt < TITLE_MENU; nCnt++)
	{
		// nullじゃなかったら
		if (m_pTitleui[nCnt] != nullptr)
		{
			// カラー変更
			if (nCnt == m_nIdx)
			{// 選択されているもの
				// カラーセット
				m_pTitleui[nCnt]->SetCol(COLOR_WHITE);
			}
			else
			{// 選択されたいないもの
				// カラーセット
				m_pTitleui[nCnt]->SetCol(COLOR_GLAY);
			}
		}
	}

	// nullじゃなかったら
	if (m_pPointUi && m_pTitleui[m_nIdx])
	{
		// 座標主h得
		D3DXVECTOR3 pos = m_pTitleui[m_nIdx]->GetPos();

		// 上にセット
		pos.y -= 100.0f; 

		// 座標を合わせる
		m_pPointUi->SetPos(pos);
	}

	// Enterキー or Startボタン
	if ((pKey->GetTrigger(DIK_RETURN) || pJoyPad->GetTrigger(pJoyPad->JOYKEY_START)) && pCamera->GetFinishRotation())
	{
		// サウンド再生
		pSound->PlaySound(CSound::SOUND_LABEL_RETURN);

		switch (m_nIdx)
		{
		case CTitleUi::MENU_GAME:		// ゲームモード
			if (pFade != nullptr) pFade->SetFade(new CGame());	// ゲームシーンに遷移
			break;

		case CTitleUi::MENU_TUTORIAL:	// チュートリアルモード
			if (pFade != nullptr) pFade->SetFade(new CTutorial());	// チュートリアルシーンに遷移
			break;

		case CTitleUi::MENU_EXIT:	// 終了メニュー
			PostQuitMessage(0);
			break;

		default:
			break;
		}
	}

#ifdef _DEBUG

	// F2キー
	if ((pKey->GetTrigger(DIK_F9)))
	{
		// 編集画面
		if (pFade != nullptr) pFade->SetFade(new CEdit());
	}

#endif // _DEBUG

}